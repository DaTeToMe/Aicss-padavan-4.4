name: Aicss-padavan-4.4
on:
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
jobs:
  build:
    runs-on: ubuntu-latest  # æŒ‡å®šå·¥ä½œæµè¿è¡Œçš„æ“ä½œç³»ç»Ÿç¯å¢ƒä¸ºæœ€æ–°çš„ Ubuntu
    strategy:
      matrix:
        target: [JCG-AC860M]  # å®šä¹‰å›ºä»¶æ„å»ºçš„ç›®æ ‡è®¾å¤‡
        toolchain: [mipsel-linux-musl]  # å®šä¹‰ä½¿ç”¨çš„å·¥å…·é“¾
    steps:
      # Step 1: æ£€å‡ºä»£ç ä»“åº“çš„å†…å®¹
      - uses: actions/checkout@main  # ä½¿ç”¨å®˜æ–¹çš„ GitHub Actions æ£€å‡ºä»£ç ä»“åº“
      
      # Step 2: é…ç½® ccache ä»¥åŠ é€Ÿç¼–è¯‘è¿‡ç¨‹
      - uses: hendrikmuhs/ccache-action@main
        with:
          key: ${{ matrix.target }}-${{ matrix.toolchain }}  # ccache çš„ç¼“å­˜é”®ä¸ç›®æ ‡è®¾å¤‡å’Œå·¥å…·é“¾ç»‘å®š
      
      # Step 3: è®¾ç½® Go ç¯å¢ƒ
      - uses: actions/setup-go@main
        with:
          go-version: '1.23.5'  # æŒ‡å®š Go çš„ç‰ˆæœ¬ä¸º 1.23.5
          check-latest: true  # ç¡®ä¿ä½¿ç”¨æœ€æ–°çš„ Go æ¬¡ç‰ˆæœ¬
          cache: false  # ç¦ç”¨ç¼“å­˜ä»¥é¿å…ä¸ä¸€è‡´çš„é—®é¢˜
      
      # Step 4: å®‰è£… UPX å‹ç¼©å·¥å…·
      - name: Install UPX
        run: |
          echo "ğŸ“¦ å®‰è£… UPX å‹ç¼©å·¥å…·..."
          wget -q https://github.com/upx/upx/releases/download/v4.2.1/upx-4.2.1-amd64_linux.tar.xz
          tar -xf upx-4.2.1-amd64_linux.tar.xz
          sudo cp upx-4.2.1-amd64_linux/upx /usr/local/bin/
          upx --version
          echo "âœ… UPX å®‰è£…å®Œæˆ"
      
      # Step 5: å‡†å¤‡æ„å»ºç¯å¢ƒ
      - name: Prepare environment
        run: |
          # æ›´æ–°è½¯ä»¶åŒ…ç®¡ç†å™¨å¹¶å®‰è£…æ‰€éœ€çš„å·¥å…·å’Œåº“
          sudo apt-get update > /dev/null 2>&1
          sudo apt-get install -y libtool-bin gperf python3-docutils autopoint gettext ccache liblzma-dev libltdl-dev unzip > /dev/null 2>&1
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"
          # å°†æ ¹ç›®å½•è·¯å¾„ä¿å­˜åˆ°ç¯å¢ƒå˜é‡ ROOTDIR
          echo "ROOTDIR=${{ github.workspace }}/trunk" >> $GITHUB_ENV
          # å°†ç¼–è¯‘æ—¶é—´ä¿å­˜ä¸ºç¯å¢ƒå˜é‡ Compilation_time,æ ¼å¼ä¸º YYYYMMDD
          echo "Compilation_time=$(TZ='Asia/Shanghai' date +%Y%m%d)" >> $GITHUB_ENV
          # ä¼˜åŒ–ç¼–è¯‘é€‰é¡¹ä»¥å‡å°å›ºä»¶ä½“ç§¯
          echo "CFLAGS=-Os -ffunction-sections -fdata-sections -fno-unwind-tables -fomit-frame-pointer" >> $GITHUB_ENV
          echo "CXXFLAGS=-Os -ffunction-sections -fdata-sections -fno-unwind-tables -fomit-frame-pointer" >> $GITHUB_ENV
          # æ³¨æ„ï¼šç§»é™¤ LDFLAGS è®¾ç½®ä»¥é¿å… Linux å†…æ ¸ç¼–è¯‘æ—¶ä¸ ld é“¾æ¥å™¨çš„å†²çª
          # Linux å†…æ ¸çš„ Kbuild ç³»ç»Ÿä¼šç›´æ¥è°ƒç”¨ ldï¼Œä¸æ”¯æŒ -Wl, å‰ç¼€
      
      # Step 6: è®¾ç½®è„šæœ¬æ–‡ä»¶çš„æƒé™
      - name: Set script permissions
        run: |
          chmod 755 trunk/user/scripts/files/usr/bin/cloudflare_ddns.sh  # è®¾ç½® Cloudflare DDNS è„šæœ¬æƒé™
          chmod 755 trunk/user/scripts/files/usr/bin/flytrap.sh  # è®¾ç½®èœœç½è„šæœ¬æƒé™
          chmod 755 trunk/user/scripts/files/usr/bin/rps-rfs-ops.sh  # è®¾ç½®ä¼˜åŒ–æ“ä½œè„šæœ¬æƒé™
          chmod 755 trunk/user/scripts/files/usr/bin/traffic.sh  # è®¾ç½®æµé‡è„šæœ¬æ“ä½œè„šæœ¬æƒé™
          echo "âœ… è„šæœ¬æƒé™è®¾ç½®å®Œæˆ"
      
      # Step 7: å¼€å§‹æ„å»ºå›ºä»¶
      - name: Start build firmware
        run: |
          echo "ğŸ”¨ å¼€å§‹ç¼–è¯‘ ${{ matrix.target }}..."
          
          # é™é»˜æ‰§è¡Œï¼Œåªåœ¨å¤±è´¥æ—¶æ˜¾ç¤ºé”™è¯¯
          if ! make -j$(nproc) ${{ matrix.target }} TOOLCHAIN=${{ matrix.toolchain }} > /dev/null 2>&1; then
            echo "âŒ ç¼–è¯‘å¤±è´¥ï¼æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ï¼š"
            make ${{ matrix.target }} TOOLCHAIN=${{ matrix.toolchain }}
            exit 1
          fi
          
          echo "âœ… ç¼–è¯‘æˆåŠŸå®Œæˆï¼"
          
          # æ˜¾ç¤ºå›ºä»¶å¤§å°
          echo "ğŸ“Š å›ºä»¶ä¿¡æ¯ï¼š"
          ls -lh trunk/images/*.trx
      
      # Step 8: ä¸Šä¼ ç¼–è¯‘ç”Ÿæˆçš„å›ºä»¶æ–‡ä»¶
      - uses: actions/upload-artifact@main
        with:
          name: ${{ matrix.target }}-${{ matrix.toolchain }}  # è®¾ç½®ä¸Šä¼ çš„æ–‡ä»¶å
          path: trunk/images/*.trx  # æŒ‡å®šä¸Šä¼ çš„å›ºä»¶æ–‡ä»¶è·¯å¾„
      
      # Step 9: åˆ›å»ºæˆ–æ›´æ–°ç‰ˆæœ¬å‘å¸ƒ
      - uses: ncipollo/release-action@main
        with:
          commit: ${{ github.sha }}  # ä½¿ç”¨å½“å‰å·¥ä½œæµè¿è¡Œçš„æäº¤å“ˆå¸Œå€¼
          tag: ${{ env.Compilation_time }}  # ä½¿ç”¨ç¼–è¯‘æ—¶é—´ä½œä¸ºæ ‡ç­¾
          artifacts: trunk/images/*.trx  # ä¸Šä¼ çš„å›ºä»¶æ–‡ä»¶
          allowUpdates: true  # å…è®¸æ›´æ–°å·²æœ‰æ ‡ç­¾çš„å‘å¸ƒ
          omitBodyDuringUpdate: true  # æ›´æ–°å‘å¸ƒæ—¶çœç•¥æ­£æ–‡å†…å®¹
      
      # Step 10: åˆ é™¤æ—§çš„å·¥ä½œæµè¿è¡Œè®°å½•
      - uses: Mattraks/delete-workflow-runs@main
        with:
          retain_days: 0  # åˆ é™¤æ‰€æœ‰è¶…è¿‡ 0 å¤©çš„è¿è¡Œè®°å½•
          keep_minimum_runs: 1  # è‡³å°‘ä¿ç•™ä¸€ä¸ªè¿è¡Œè®°å½•
