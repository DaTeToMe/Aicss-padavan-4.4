name: Aicss-padavan-4.4
on:
  workflow_dispatch:
jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target: [JDCLOUD-RE-SP-01B]
        toolchain: [mipsel-linux-musl]
    steps:
      - uses: actions/checkout@main
      
      - uses: hendrikmuhs/ccache-action@main
        with:
          key: ${{ matrix.target }}-${{ matrix.toolchain }}
      
      - uses: actions/setup-go@main
        with:
          go-version: '1.23.5'
          check-latest: true
          cache: false
      
      - name: Install UPX
        run: |
          echo "ğŸ“¦ å®‰è£… UPX å‹ç¼©å·¥å…·..."
          wget -q https://github.com/upx/upx/releases/download/v4.2.1/upx-4.2.1-amd64_linux.tar.xz
          tar -xf upx-4.2.1-amd64_linux.tar.xz
          sudo cp upx-4.2.1-amd64_linux/upx /usr/local/bin/
          upx --version
          echo "âœ… UPX å®‰è£…å®Œæˆ"
      
      - name: Prepare environment
        run: |
          sudo apt-get update > /dev/null 2>&1
          sudo apt-get install -y libtool-bin gperf python3-docutils autopoint gettext ccache liblzma-dev libltdl-dev unzip > /dev/null 2>&1
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"
          
          echo "ROOTDIR=${{ github.workspace }}/trunk" >> $GITHUB_ENV
          echo "Compilation_time=$(TZ='Asia/Shanghai' date +%Y%m%d)" >> $GITHUB_ENV
          
          # æ›´æ¿€è¿›çš„ä½“ç§¯ä¼˜åŒ–é€‰é¡¹ï¼ˆåªæ·»åŠ ç¼–è¯‘é€‰é¡¹ï¼Œä¸æ·»åŠ é“¾æ¥é€‰é¡¹ï¼‰
          echo "CFLAGS=-Os -ffunction-sections -fdata-sections -fno-unwind-tables -fomit-frame-pointer -fno-asynchronous-unwind-tables -fmerge-all-constants" >> $GITHUB_ENV
          echo "CXXFLAGS=-Os -ffunction-sections -fdata-sections -fno-unwind-tables -fomit-frame-pointer -fno-asynchronous-unwind-tables -fmerge-all-constants" >> $GITHUB_ENV
          
          # æ³¨æ„ï¼šä¸åœ¨è¿™é‡Œè®¾ç½®å…¨å±€ LDFLAGSï¼Œé¿å…ç ´åä¾èµ–åº“çš„é“¾æ¥
      
      - name: Set script permissions
        run: |
          chmod 755 trunk/user/scripts/files/usr/bin/cloudflare_ddns.sh
          chmod 755 trunk/user/scripts/files/usr/bin/flytrap.sh
          chmod 755 trunk/user/scripts/files/usr/bin/rps-rfs-ops.sh
          chmod 755 trunk/user/scripts/files/usr/bin/traffic.sh
          echo "âœ… è„šæœ¬æƒé™è®¾ç½®å®Œæˆ"
      
      - name: Start build firmware
        run: |
          echo "ğŸ”¨ å¼€å§‹ç¼–è¯‘ ${{ matrix.target }}..."
          
          if ! make -j$(nproc) ${{ matrix.target }} TOOLCHAIN=${{ matrix.toolchain }} > /dev/null 2>&1; then
            echo "âŒ ç¼–è¯‘å¤±è´¥ï¼æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ï¼š"
            make ${{ matrix.target }} TOOLCHAIN=${{ matrix.toolchain }}
            exit 1
          fi
          
          echo "âœ… ç¼–è¯‘æˆåŠŸå®Œæˆï¼"
          
          echo "ğŸ“Š å›ºä»¶ä¿¡æ¯ï¼š"
          ls -lh trunk/images/*.trx
      
      - uses: actions/upload-artifact@main
        with:
          name: ${{ matrix.target }}-${{ matrix.toolchain }}
          path: trunk/images/*.trx
      
      - uses: ncipollo/release-action@main
        with:
          commit: ${{ github.sha }}
          tag: ${{ env.Compilation_time }}
          artifacts: trunk/images/*.trx
          allowUpdates: true
          omitBodyDuringUpdate: true
      
      - uses: Mattraks/delete-workflow-runs@main
        with:
          retain_days: 0
          keep_minimum_runs: 1
