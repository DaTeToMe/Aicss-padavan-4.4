name: Aicss-padavan-4.4
on:
  workflow_dispatch:
jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target: [JCG-AC860M]
        toolchain: [mipsel-linux-musl]
    steps:
      - uses: actions/checkout@main
      
      - uses: hendrikmuhs/ccache-action@main
        with:
          key: ${{ matrix.target }}-${{ matrix.toolchain }}
      
      - uses: actions/setup-go@main
        with:
          go-version: '1.23.5'
          check-latest: true
          cache: false
      
      - name: Install UPX
        run: |
          echo "ğŸ“¦ å®‰è£… UPX å‹ç¼©å·¥å…·..."
          wget -q https://github.com/upx/upx/releases/download/v4.2.1/upx-4.2.1-amd64_linux.tar.xz
          tar -xf upx-4.2.1-amd64_linux.tar.xz
          sudo cp upx-4.2.1-amd64_linux/upx /usr/local/bin/
          upx --version
          echo "âœ… UPX å®‰è£…å®Œæˆ"
      
      - name: Prepare environment
        run: |
          sudo apt-get update > /dev/null 2>&1
          sudo apt-get install -y libtool-bin gperf python3-docutils autopoint gettext ccache liblzma-dev libltdl-dev unzip > /dev/null 2>&1
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"
          
          echo "ROOTDIR=${{ github.workspace }}/trunk" >> $GITHUB_ENV
          echo "Compilation_time=$(TZ='Asia/Shanghai' date +%Y%m%d)" >> $GITHUB_ENV
          
          # æ›´æ¿€è¿›çš„ä½“ç§¯ä¼˜åŒ–é€‰é¡¹
          echo "CFLAGS=-Os -ffunction-sections -fdata-sections -fno-unwind-tables -fomit-frame-pointer -fno-asynchronous-unwind-tables -fmerge-all-constants" >> $GITHUB_ENV
          echo "CXXFLAGS=-Os -ffunction-sections -fdata-sections -fno-unwind-tables -fomit-frame-pointer -fno-asynchronous-unwind-tables -fmerge-all-constants" >> $GITHUB_ENV
          
          # é’ˆå¯¹ userspace åº”ç”¨æ·»åŠ é“¾æ¥æ—¶åƒåœ¾å›æ”¶ï¼ˆé¿å…å†…æ ¸ç¼–è¯‘é—®é¢˜ï¼‰
          echo "USERSPACE_LDFLAGS=-Wl,--gc-sections -Wl,--as-needed -Wl,-s" >> $GITHUB_ENV
      
      - name: Set script permissions
        run: |
          chmod 755 trunk/user/scripts/files/usr/bin/cloudflare_ddns.sh
          chmod 755 trunk/user/scripts/files/usr/bin/flytrap.sh
          chmod 755 trunk/user/scripts/files/usr/bin/rps-rfs-ops.sh
          chmod 755 trunk/user/scripts/files/usr/bin/traffic.sh
          echo "âœ… è„šæœ¬æƒé™è®¾ç½®å®Œæˆ"
      
      - name: Apply size optimizations
        run: |
          echo "ğŸ”§ åº”ç”¨å›ºä»¶ä½“ç§¯ä¼˜åŒ–..."
          
          # 1. ä¼˜åŒ–å†…æ ¸é…ç½®ï¼ˆå¦‚æœæœ‰ .config æ–‡ä»¶ï¼‰
          if [ -f trunk/configs/boards/${{ matrix.target }}/kernel-*.config ]; then
            echo "ä¼˜åŒ–å†…æ ¸é…ç½®..."
            # è¿™é‡Œå¯ä»¥æ·»åŠ å†…æ ¸é…ç½®ä¼˜åŒ–
          fi
          
          # 2. è®¾ç½® userspace ç¼–è¯‘ä¼˜åŒ–
          if [ -f trunk/user/Makefile ]; then
            # å°† LDFLAGS æ³¨å…¥åˆ° user Makefile
            sed -i '/^export LDFLAGS/d' trunk/user/Makefile
            echo "export LDFLAGS := \$(USERSPACE_LDFLAGS)" >> trunk/user/Makefile
          fi
          
          echo "âœ… ä¼˜åŒ–é…ç½®å®Œæˆ"
      
      - name: Start build firmware
        run: |
          echo "ğŸ”¨ å¼€å§‹ç¼–è¯‘ ${{ matrix.target }}..."
          echo "ğŸ“Š ç¼–è¯‘å‰ç£ç›˜ç©ºé—´ï¼š"
          df -h
          
          if ! make -j$(nproc) ${{ matrix.target }} TOOLCHAIN=${{ matrix.toolchain }} > build.log 2>&1; then
            echo "âŒ ç¼–è¯‘å¤±è´¥ï¼æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ï¼š"
            tail -n 100 build.log
            exit 1
          fi
          
          echo "âœ… ç¼–è¯‘æˆåŠŸå®Œæˆï¼"
          
          # æ˜¾ç¤ºå›ºä»¶è¯¦ç»†ä¿¡æ¯
          echo "ğŸ“Š å›ºä»¶ä¿¡æ¯ï¼š"
          ls -lh trunk/images/*.trx
          
          # æ˜¾ç¤ºå›ºä»¶åˆ†åŒºå¤§å°ï¼ˆå¦‚æœå¯ç”¨ï¼‰
          if command -v binwalk &> /dev/null; then
            echo "ğŸ“¦ å›ºä»¶ç»“æ„åˆ†æï¼š"
            binwalk trunk/images/*.trx | head -20
          fi
          
          # è®¡ç®—å‹ç¼©æ¯”
          ORIGINAL_SIZE=$(stat -c%s trunk/images/*.trx 2>/dev/null || echo "unknown")
          echo "å›ºä»¶å¤§å°: $ORIGINAL_SIZE bytes"
      
      - name: Compress firmware (optional)
        run: |
          echo "ğŸ—œï¸ å°è¯•è¿›ä¸€æ­¥å‹ç¼©å›ºä»¶..."
          
          # å¤‡ä»½åŸå§‹å›ºä»¶
          cp trunk/images/*.trx trunk/images/*.trx.backup
          
          # ä½¿ç”¨ xz å‹ç¼©ï¼ˆå¯é€‰ï¼Œç”¨äºå­˜å‚¨ï¼‰
          if command -v xz &> /dev/null; then
            xz -9 -k trunk/images/*.trx.backup
            echo "âœ… åˆ›å»ºäº† .xz å‹ç¼©ç‰ˆæœ¬"
          fi
          
          echo "ğŸ“Š æœ€ç»ˆæ–‡ä»¶ï¼š"
          ls -lh trunk/images/
      
      - uses: actions/upload-artifact@main
        with:
          name: ${{ matrix.target }}-${{ matrix.toolchain }}
          path: |
            trunk/images/*.trx
            trunk/images/*.trx.backup.xz
      
      - uses: ncipollo/release-action@main
        with:
          commit: ${{ github.sha }}
          tag: ${{ env.Compilation_time }}
          artifacts: trunk/images/*.trx
          allowUpdates: true
          omitBodyDuringUpdate: true
          body: |
            ## å›ºä»¶ä¿¡æ¯
            - ç¼–è¯‘ç›®æ ‡: ${{ matrix.target }}
            - å·¥å…·é“¾: ${{ matrix.toolchain }}
            - ç¼–è¯‘æ—¶é—´: ${{ env.Compilation_time }}
            - ä¼˜åŒ–çº§åˆ«: ä½“ç§¯ä¼˜åŒ– (-Os + GC Sections)
      
      - uses: Mattraks/delete-workflow-runs@main
        with:
          retain_days: 0
          keep_minimum_runs: 1
